<script setup lang="ts">
import NewCardList from "@/components/cards/NewCardList/index.vue";
import CardOperator from "@/components/CardOperator.vue";
import LayoutCardComponent from "@/components/cards/LayoutCard.vue";
import PlaceHolderCard from "@/components/cards/PlaceHolderCard.vue";
import { useLayoutConfigStore } from "@/stores/useLayoutConfig";
import { useCardDragMove } from "@/hooks/useCardDragMove";
import {
  useCardLayoutComputed,
  PLACE_HOLDER_CARD,
} from "@/hooks/useCardLayoutComputed";
import { useRouterParams } from "../hooks/useRouterParams";
import { useLayoutContainerStore } from "@/stores/useLayoutContainerStore";
import { useScreen } from "@/hooks/useScreen";

const { containerState } = useLayoutContainerStore();
const { currentRoutePath } = useRouterParams();
const { getPageLayoutConfig } = useLayoutConfigStore();
const currentLayoutConfig = getPageLayoutConfig(currentRoutePath.value);
const { computedLayout } = useCardLayoutComputed(currentLayoutConfig);

const screen = useScreen();
// const isMobile = computed(() => screen.isMobile.value);

const {
  dragover,
  dragleave,
  drop,
  dragstart,
  dropToNewArea,
  dragenter,
  newAreaDragenter,
  newAreaDragleave,
} = useCardDragMove();
</script>

<template>
  <main class="main-layout-container">
    <!-- 新增卡片对话框 -->
    <NewCardList v-if="containerState.isDesignMode" ref="newCardList">
    </NewCardList>

    <a-row
      :class="{ 'row-order-mode': containerState.isDesignMode }"
      v-if="currentLayoutConfig.length > 1"
      :gutter="[24, 24]"
    >
      <a-col
        v-for="card in computedLayout"
        :key="card.id"
        :span="24"
        :md="24"
        :lg="card.width * 2"
        class="layout-card-col transition-all-6"
        :class="{ 'is-order-mode': containerState.isDesignMode }"
        :data-card-type="card.type"
        :style="{ minHeight: card.height }"
      >
        <CardOperator
          v-if="card.type != PLACE_HOLDER_CARD && containerState.isDesignMode"
          :card="card"
        ></CardOperator>
        <LayoutCardComponent
          v-if="card.type != PLACE_HOLDER_CARD"
          :card="card"
          :data-id="card.id"
          :design-mode="containerState.isDesignMode"
          :draggable="containerState.isDesignMode"
          @dragstart="(e: DragEvent) => dragstart(e, card.id)"
          @dragover="(e: DragEvent) => dragover(e, card.id)"
          @dragleave="(e: DragEvent) => dragleave(e, card.id)"
          @dragenter="(e: DragEvent) => dragenter(e, card.id)"
          @drop="(e: DragEvent) => drop(e, card.id)"
        >
        </LayoutCardComponent>

        <PlaceHolderCard
          v-else-if="card.type == PLACE_HOLDER_CARD"
          :id="'layout-card-container-' + card.id"
          :design-mode="containerState.isDesignMode"
          :card="card"
          :data-id="card.id"
          :draggable="containerState.isDesignMode"
          @dragstart="(e: DragEvent) => e.preventDefault()"
          @dragover="(e: DragEvent) => e.preventDefault()"
          @dragleave="(e: DragEvent) => newAreaDragleave(e)"
          @dragenter="(e: DragEvent) => newAreaDragenter(e)"
          @drop="(e: DragEvent) => dropToNewArea(e, String(card.followId))"
        >
        </PlaceHolderCard>
      </a-col>
    </a-row>

    <div
      class="main-flex-center"
      v-if="currentLayoutConfig.length <= 1 && currentLayoutConfig.length != 0"
    >
      <a-row :gutter="[0, 0]" align="center" style="width: 100%">
        <a-col
          :span="24"
          :md="24"
          :lg="currentLayoutConfig[0].width * 2"
          class="layout-card-col transition-all-6"
        >
          <CardOperator
            v-if="containerState.isDesignMode"
            :card="currentLayoutConfig[0]"
          ></CardOperator>
          <LayoutCardComponent
            :card="currentLayoutConfig[0]"
            :data-id="currentLayoutConfig[0].id"
            :style="{ height: currentLayoutConfig[0].height }"
          >
          </LayoutCardComponent>
        </a-col>
      </a-row>
    </div>
  </main>
</template>

<style lang="scss">
// Gloabl
@import "../assets/variables.scss";

// Hide the EmptyCard component when mobile device.
@media (max-width: 960px) {
  .layout-card-col[data-card-type="EmptyCard"] {
    display: none;
  }
  .layout-card-col[data-card-type="PLACEHOLDER"] {
    display: none;
  }
}
.is-order-mode[data-card-type="EmptyCard"] {
  .layout-card-container {
    border: 1px dashed $gray-border-color;
    background-color: $color-gray-5;
    border-radius: 4px;
    height: 100%;
  }
}
</style>

<style lang="scss" scoped>
@import "../assets/global.scss";

.layout-card-col {
  position: relative;
}
.main-flex-center {
  margin-top: 10vh;
  height: 100%;
  width: 100%;
  text-align: center;
}
.main-layout-container {
  position: relative;
  animation: scaleAnimation 0.6s ease-in-out;
  min-height: 100%;
  margin: auto;
  padding-bottom: 20px;
}

@keyframes scaleAnimation {
  0% {
    opacity: 0;
    transform: scale(0.96);
  }

  100% {
    opacity: 1;
    transform: scale(1);
  }
}
</style>
